-- Â© 2011 David Given.
-- Stellation 3 is licensed under the MIT open source license. See the COPYING
-- file in this distribution for the full text.

include "tools/c.pm"

CEXTRAFLAGS = {
	PARENT,
	"-Os"
}

CLIBRARIES = {
	"zmq"
}

unique_keys = simple {
	command = "grep '^[a-z]' %in% | uniq > %out%",
	outputs = {"%U%-%I%"},
	
	file "src/keys.txt"
}

make_gperf_hash = simple {
	command = "gperf -C -j1 -n -E -L ANSI-C -H propertyHash -N propertyLookup %in% > %out%",
	outputs = {"%U%/hash.h"},
	
	unique_keys
}

make_accessors_h = simple {
	command = {"./pm -f %in[1]% %in[2]% %out%"},
	outputs = {"%U%/accessors.h"},
	
	file "tools/make-accessors-h.pm",
	unique_keys
} 

make_accessors_cc_h = simple {
	command = {"./pm -f %in[1]% %in[2]% %out%"},
	outputs = {"%U%/accessors-cc.h"},
	
	file "tools/make-accessors-cc.pm",
	unique_keys
} 

mycxxfile = cxxfile {
	class = "mycxxfile",
	dynamicheaders = make_accessors_h
}

server_exe = cxxprogram {
	CINCLUDES = {
		PARENT,
		"src/server",
		"src/server/database",
		"src/server/model"
	},
	
	mycxxfile "src/server/main.cc",
	mycxxfile "src/server/utils.cc",
	mycxxfile "src/server/worldcreation.cc",
	mycxxfile "src/server/database/Database.cc",
	mycxxfile "src/server/database/Datum.cc",
	mycxxfile { "src/server/database/DatabaseObject.cc",
		dynamicheaders = {make_accessors_h, make_gperf_hash}
	},
	mycxxfile { "src/server/model/SObject.cc",
		dynamicheaders = {make_accessors_h, make_accessors_cc_h}
	},
	mycxxfile "src/server/model/SGalaxy.cc",
	mycxxfile "src/server/model/SStar.cc",
	
	install = pm.install("bin/server")
}

default = server_exe